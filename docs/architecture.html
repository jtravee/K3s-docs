<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-architecture/architecture">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<title data-rh="true">Architecture | K3s</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://k3s-io.github.io/docs/docs/architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | K3s"><meta data-rh="true" name="description" content="This page describes the architecture of a high-availability K3s server cluster and how it differs from a single-node server cluster."><meta data-rh="true" property="og:description" content="This page describes the architecture of a high-availability K3s server cluster and how it differs from a single-node server cluster."><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://k3s-io.github.io/docs/docs/architecture"><link data-rh="true" rel="alternate" href="https://k3s-io.github.io/docs/docs/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://k3s-io.github.io/docs/docs/architecture" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.b6141f38.css">
<link rel="preload" href="/docs/assets/js/runtime~main.33e19d74.js" as="script">
<link rel="preload" href="/docs/assets/js/main.4c2ff82a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/k3s-logo-light.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/k3s-logo-dark.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__docs navbar__link--active" href="/docs/docs">Docs</a><a href="https://github.com/k3s-io/k3s/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs">K3s - Lightweight Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/docs/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/quick-start">Quick-Start Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docs/installation">Installation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/cluster-access">Cluster Access</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docs/upgrades">Upgrades</a><button aria-label="Toggle the collapsible sidebar category &#x27;Upgrades&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/backup-restore">Backup and Restore</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/storage">Volumes and Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/helm">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/advanced">Advanced Options and Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docs/reference/server-config">Reference</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docs/known-issues">Known Issues</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docs/security">Security</a><button aria-label="Toggle the collapsible sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Architecture</h1></header><p>This page describes the architecture of a high-availability K3s server cluster and how it differs from a single-node server cluster.</p><p>It also describes how agent nodes are registered with K3s servers.</p><p>A server node is defined as a machine (bare-metal or virtual) running the <code>k3s server</code> command. A worker node is defined as a machine running the <code>k3s agent</code> command.</p><p>This page covers the following topics:</p><ul><li><a href="#single-server-setup-with-an-embedded-db">Single-server setup with an embedded database</a></li><li><a href="#high-availability-k3s-server-with-an-external-db">High-availability K3s server with an external database</a><ul><li><a href="#fixed-registration-address-for-agent-nodes">Fixed registration address for agent nodes</a></li></ul></li><li><a href="#how-agent-node-registration-works">How agent node registration works</a></li><li><a href="#automatically-deployed-manifests">Automatically deployed manifests</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="single-server-setup-with-an-embedded-db">Single-server Setup with an Embedded DB<a class="hash-link" href="#single-server-setup-with-an-embedded-db" title="Direct link to heading">​</a></h3><p>The following diagram shows an example of a cluster that has a single-node K3s server with an embedded SQLite database.</p><p>In this configuration, each agent node is registered to the same server node. A K3s user can manipulate Kubernetes resources by calling the K3s API on the server node.</p><img src="/docs/img/k3s-architecture-single-server.svg" alt="K3s Architecture with a Single Server" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/k3s-architecture-single-server-dark.svg" alt="K3s Architecture with a Single Server" class="themedImage_ToTc themedImage--dark_i4oU"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="high-availability-k3s-server-with-an-external-db">High-Availability K3s Server with an External DB<a class="hash-link" href="#high-availability-k3s-server-with-an-external-db" title="Direct link to heading">​</a></h3><p>Single server clusters can meet a variety of use cases, but for environments where uptime of the Kubernetes control plane is critical, you can run K3s in an HA configuration. An HA K3s cluster is comprised of:</p><ul><li>Two or more <strong>server nodes</strong> that will serve the Kubernetes API and run other control plane services</li><li>An <strong>external datastore</strong> (as opposed to the embedded SQLite datastore used in single-server setups)</li></ul><img src="/docs/img/k3s-architecture-ha-server.svg" alt="K3s Architecture with High-availability Servers" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/k3s-architecture-ha-server-dark.svg" alt="K3s Architecture with High-availability Servers" class="themedImage_ToTc themedImage--dark_i4oU"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-registration-address-for-agent-nodes">Fixed Registration Address for Agent Nodes<a class="hash-link" href="#fixed-registration-address-for-agent-nodes" title="Direct link to heading">​</a></h3><p>In the high-availability server configuration, each node must also register with the Kubernetes API by using a fixed registration address, as shown in the diagram below.</p><p>After registration, the agent nodes establish a connection directly to one of the server nodes.</p><img src="/docs/img/k3s-production-setup.svg" alt="Agent Registration HA" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/k3s-production-setup-dark.svg" alt="Agent Registration HA" class="themedImage_ToTc themedImage--dark_i4oU"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-agent-node-registration-works">How Agent Node Registration Works<a class="hash-link" href="#how-agent-node-registration-works" title="Direct link to heading">​</a></h3><p>Agent nodes are registered with a websocket connection initiated by the <code>k3s agent</code> process, and the connection is maintained by a client-side load balancer running as part of the agent process.</p><p>Agents will register with the server using the node cluster secret along with a randomly generated password for the node, stored at <code>/etc/rancher/node/password</code>. The server will store the passwords for individual nodes as Kubernetes secrets, and any subsequent attempts must use the same password. Node password secrets are stored in the <code>kube-system</code> namespace with names using the template <code>&lt;host&gt;.node-password.k3s</code>.</p><p>Note: Prior to K3s v1.20.2 servers stored passwords on disk at <code>/var/lib/rancher/k3s/server/cred/node-passwd</code>.</p><p>If the <code>/etc/rancher/node</code> directory of an agent is removed, the password file should be recreated for the agent, or the entry removed from the server.</p><p>A unique node ID can be appended to the hostname by launching K3s servers or agents using the <code>--with-node-id</code> flag.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatically-deployed-manifests">Automatically Deployed Manifests<a class="hash-link" href="#automatically-deployed-manifests" title="Direct link to heading">​</a></h3><p>The <a href="https://github.com/rancher/k3s/tree/master/manifests" target="_blank" rel="noopener noreferrer">manifests</a> located at the directory path <code>/var/lib/rancher/k3s/server/manifests</code> are bundled into the K3s binary at build time.  These will be installed at runtime by the <a href="https://github.com/rancher/helm-controller#helm-controller" target="_blank" rel="noopener noreferrer">rancher/helm-controller.</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/k3s-io/docs/edit/main/docs/architecture/architecture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-08-08T16:43:42.000Z">Aug 8, 2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/docs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">K3s - Lightweight Kubernetes</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/docs/quick-start"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Quick-Start Guide</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#single-server-setup-with-an-embedded-db" class="table-of-contents__link toc-highlight">Single-server Setup with an Embedded DB</a></li><li><a href="#high-availability-k3s-server-with-an-external-db" class="table-of-contents__link toc-highlight">High-Availability K3s Server with an External DB</a></li><li><a href="#fixed-registration-address-for-agent-nodes" class="table-of-contents__link toc-highlight">Fixed Registration Address for Agent Nodes</a></li><li><a href="#how-agent-node-registration-works" class="table-of-contents__link toc-highlight">How Agent Node Registration Works</a></li><li><a href="#automatically-deployed-manifests" class="table-of-contents__link toc-highlight">Automatically Deployed Manifests</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 K3s Project Authors. All rights reserved. <br>The Linux Foundation has registered trademarks
      and uses trademarks. For a list of trademarks of The Linux Foundation, 
      please see our <a href="https://www.linuxfoundation.org/trademark-usage"> Trademark Usage</a> page.</div></div></div></footer></div>
<script src="/docs/assets/js/runtime~main.33e19d74.js"></script>
<script src="/docs/assets/js/main.4c2ff82a.js"></script>
</body>
</html>